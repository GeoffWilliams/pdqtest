# PDK Integration

First off, what is PDK? PDK is Puppet's development kit. The bits we are 
interested in right now are:
* Validation `pdk validate...`
* Testing `pdk test...`
* Packaging `pdk build...`

There's a lot more to PDK then just running simple tests though, PDK includes
its own version of ruby and various other tools.

On Linux PDK behaves (or at least appears to behave...) like a thin wrapper 
around ruby, in the same vein as RBENV/RVM. On Windows, things are more involved
since it needs to install specific system libraries and reference them at
runtime somehow. This is why running `bundle install` on PDK project in windows
can cause strange and interesting blow-ups (don't do that!).

## What's the point of PDQTest if we have PDK?
PDQTest provides an easy way to run acceptance tests using light-weight
Docker containers which we abuse to the point of treating them _almost_ like 
VMs in order to extract maximum speed. It offers a different approach to 
[Beaker](https://github.com/puppetlabs/beaker):
* Minimal to no project configuration required, just `metadata.json` and a few 
  other files we setup for you
* Simple acceptance tests written in BASH or PowerShell
* Provide _good enough_ (but not perfect) testing:
    * Generic Ubuntu, Centos, Windows test environments 
    * Capable of mocking large/slow/networked systems by replacing or installing
      binaries inside the container at the OS level, eg:
      * Fake installation of Database server's by mocking the installer your
        puppet `exec` would call with a simple python script
      * Network tools such as `realmd` with a simple mock `realm` command
        written in Python
      * Complex OS commands that need to report different state between puppet
        runs can be mocked with Python and a small SQLite database or simple
        text files (eg the `sysctl` command)
      * Fake different Unix-like Operating Systems like AIX by subverting the 
        commands that your puppet code would executes. This is particularly 
        useful in this case since there are no AIX desktop virtualisation 
        solutions right now and there probably never will be
      * See [examples](examples.md) for real-world modules using these
        techniques

Of course, this will only ever give you an approximation of a real-world system
but in many cases this is all that's needed. The complexity of setting up a
100% accurate test environment is a daunting task and one that may never provide
ROI vs the effort spent configuring and maintaining it.

If perfect accuracy is indeed required, then PDQTest is not what you are looking
for and you should look towards solutions like Beaker or 
[Kitchen CI](https://kitchen.ci/).

## How does PDQTest work with PDK? Do I have to choose?

No you don't have to choose! PDQTest integrates with PDK by making the minimal
amount of invasive changes:

### New projects
New projects should be created using PDK: `pdk new module`. 

This will give you all the PDK versioned files you would ever need. When you run
`pdqtest init` on a new project created with PDK, we only copy in our own 
integration files and do not not touch the PDK generated files at all (the ones
marked ðŸ›  below).

After running `pdqtest init`, run `pdk update` to have PDK process the
`.sync.yml` we installed.

### Existing PDQTest projects
To make upgrading to PDQTest 2.0 + PDK easy for our existing users, we automate
the workflow normally carried out by `pdk convert`:

We do not include the entire set of files that would have been generated by
`pdk convert` or `pdk new module`. If you want the full set, you should run 
one of these commands yourself before `pdqtest init` and they will be left alone
unless PDK starts writing new files that we are already using.

**metadata.json**

* Enable PDK by adding the fields:
    * `pdk-version`
    * `template-url`
    * `template-ref`
  The values for these fields are obtained automatically from PDK itself and are
  consistent with the system installed PDK (we generate a temporary project and 
  read files/values from it).

**Gemfile.project**

If you require PDK to know about a particular gem for your project, add it to
this file and then run:

*Linux*
```shell
make Gemfile.local
```

*Windows*
```shell
.\make.ps1 Gemfile.local
```

Depending on platform, this will symlink or copy `Gemfile.project` to 
`Gemfile.local` respectively, then run `pdk bundle install` to update PDK's 
knowledge of the new gem.


**Miscellaneous skeletons**

When `pdqtest init` is run, we install a small set of skeleton files in the root
of your project. This is a one-off operation to get you started and is _only_
done if your project is not already marked PDK compatible. 

After your module has been marked as PDK compatible, you must only manage these
files using PDK.

Skeletons are generated on the fly using PDK itself, so they are always 
up-to-date according to the PDK you have installed on your system.

### Existing non-PDQTest projects
If you have an existing Puppet project that does not use PDQTest or PDK (eg 
created by hand or with the old `puppet module generate` command), then the 
recommended way to enable PDQTest is to first enable PDK by running 
`pdk convert`, then follow the wizard.

You may then enable `PDQTest` by running `pdqtest init`.

Depending on the state of your project, you may be able to bypass the 
`pdk convert` process by just running `pdqtest init` but this isn't recommended
or supported.


### PDQTest directory structure
These are the files installed, files marked ðŸ›  are generated by PDK:

```
â”œâ”€â”€ bitbucket-pipelines.yml
â”œâ”€â”€ Gemfile ðŸ› 
â”œâ”€â”€ Gemfile.local
â”œâ”€â”€ Gemfile.project
â”œâ”€â”€ .gitignore ðŸ› 
â”œâ”€â”€ Makefile
â”œâ”€â”€ make.ps1
â”œâ”€â”€ .pdkignore ðŸ› 
â”œâ”€â”€ .puppet-lint.rc
â”œâ”€â”€ Rakefile ðŸ› 
â”œâ”€â”€ spec
â”‚Â Â  â”œâ”€â”€ default_facts.yml ðŸ› 
â”‚Â Â  â”œâ”€â”€ fixtures
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ hieradata
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ test.yaml
â”‚Â Â  â”‚Â Â  â””â”€â”€ hiera.yaml
â”‚Â Â  â””â”€â”€ spec_helper.rb ðŸ› 
â””â”€â”€ .travis.yml
```

The remaining files are specific to PDQTest - notably:
* `.travis.yml` - Complete test suite for Linux modules
* `bitbucket-pipelines.yaml` - logical testing only (unit/RSpec) 
* `.puppet-lint.rc` - Make lint errors test failures, ignore double quotes, etc
* `Makefile` - Essential launch script for Linux
* `make.ps1` - Essential launch script for Windows
* `spec/fixtures/hiera.yaml` - Mock system-wide `hiera.yaml` file
* `spec/fixtures/hieradata/test.yaml` - Mock system-wide hieradata
* `Gemfile.project` - Used to enable the PDQTest gem (and any others you need)
* `Gemfile.local` - Transient file created at runtime by `Makefile` or
  `make.ps1` to enable the PDQTest gem at runtime. This is a vital integration
  point, see details below
* `.gitignore` - PDK has a massive list of files to ignore for new projects so
  these are imported


## Why are the launch scripts essential/How does the PDQTest gem load itself?
PDK provides its own `Gemfile` to select the gems available at runtime. There
are hooks in this file to load additional configuration from two locations:
* `~/.gemfile`
* `YOUR_PROJECT/Gemfile.local`

We support side-by-side installation of all versions of PDQTest so that users
are not forced to upgrade when they are not ready to, so we need a per-project
way to load our gem into the bundle. `Gemfile.local` is perfect for this but we
are not supposed to store permanent data in there according to PDK's generated
`.gitignore`.

The simplest way to workaround this issue is for us to create a symlink from 
`Gemfile.project` to `Gemfile.local` at runtime and we _must_ use our launch
scripts to do this since we are unable to use any Ruby code to do this trick
since we are not yet in the bundle.

For this reason, you **must** launch PDQTest using the provided `Makefile` or
`make.ps1` scripts, at least initially.

For further background see: 
* [PDK-1177](https://tickets.puppetlabs.com/browse/PDK-1177) and 
* [#50](https://github.com/declarativesystems/pdqtest/issues/50) 

## When developing PDQTest, your version number **must** match a released version
_This should only affects PDQTest developers - for posterity..._

Due to some strange hackery between `pdk bundle` and `bundle exec` you have one
more gotcha when it comes to using developing PDQTest and thats that the version
number of the gem you build *MUST* match a released version of the gem on 
rubygems.org otherwise `bundle exec` will barf with errors like this:

```shell
$ bundle exec pdqtest
Could not find hiera-3.4.5 in any of the sources
Run `bundle install` to install missing gems.
```

There seems no other way to fix this other than building the development gem 
with a version matching an existing release. The gem then needs to be installed
using `gem install ...` and it will then magically start working. Using other
gem tricks like setting `:path` will appear to work but fail when `bundle exec`
is called. The other approach of trying to run everything with 
`pdk bundle exec pdqtest` fails with various errors depending what platform your
on, presumably because `pdqtest` runs `pdk` command as part of its tests.

The final final caveat of this approach is that the PDQTest gem dependencies are
pinned at whatever the _real_ release uses, so if any were changed or added they
need to be temporarily added to `Gemfile.project`

The above works on Linux... For windows there is also the situation where:
* PDK vendors its own gems that magically appear
* PDK can only use "published" gems(specs?) it downloads - or appears to
* when you go to `bundle install` without using PDK you blow up the lock 
  file
* When you `bundle exec pdqtest` you get the above error because _something_
  uses the old one `gemspec`
* The answer seems to be:
    1. use `gem 'pdqtest', :path=>'c:/vagrant/pdqtest'` in `Gemfile.local`
    2. `pdk bundle install`
    3. `bundle update pdqtest` - yes even though your not supposed to...
    4. `bundle exec pdqtest` - now it should work... why is beyond me
* If you still have errors:
    1. `bundle install`
    2. `rm Gemfile.lock`
    3. `pdk bundle install` - working?

Somtimes you just have to upload the whole gem file as a pre-release object:
* Version set to x.x.xWHATEVER
* `gem push pdqtest-x.x.xWHATEVER.gem`
* `gem install pdqtest --pre`


If your just want to use PDQTest, you will hopefully never have to worry about
this... On the other hand, if this all sounds confusing... That's because it is!

## What happens when I upgrade PDQTest?
When a new version of PDQTest is released, upgrade by running:

```shell
gem install pdqtest
cd /your/project
pdqtest upgrade
pdk bundle install
```

This updates:
* Project gems in `Gemfile.project` (currently `pdqtest` and `puppet-strings`)
* Our CI and CLI integrations:
    * `Makefile`
    * `make.ps1`
    * `.travis.yml`
    * `bitbucket-pipelines.yml`
    
The final `pdk bundle install` command upgrades PDK's bundle to the include our
update and is critical to making the whole process work.

## What happens when I upgrade PDK?
PDK operates independently from PDQTest and maintains its own files. Your free
to run `pdk update` to upgrade the your files to the latest PDK templated ones
at any time.

To protect PDQTest files from alteration (notably `.travis.yml` and
`bitbucket-pipelines.yml`) we merge them with any existing `.sync.yml` to
prevent churn.

If you have further customisations to PDK controlled files your options are:
* Use git to revert any change by PDK
* Use `.sync.yml` to influence file (re)generation
  [blog](https://puppet.com/blog/guide-converting-module-pdk)
  [reference](https://github.com/puppetlabs/pdk-templates) 
  [example](https://github.com/puppetlabs/puppetlabs-apt/blob/master/.sync.yml) 

## How do I use PDK with PDQTest installed? What can and can't I do?
You can run any `pdk` command as described in the PDK documentation. PDQTest
does not stop you running anything. If you find this not to be the case please
open a [ticket](https://github.com/declarativesystems/pdqtest/issues)

## How do PDQTest lifecycle tests relate to PDK?

| PDQTest   | PDK                            |
| ---       | ---                            |
| `syntax`  | `pdk validate metadata,puppet` |
| `rspec`   | `pdk test unit`                |
| `build`   | `pdk build --force`            |    

* Previous `lint` subcommand was removed in PDQTest 2.0 as its now covered by 
  `syntax`

## What actually happens when I run PDQTest?

`bundle exec pdqtest all` is the default target executed by `make` and 
`.\make.ps1`. There are a few other targets that let you skip parts of the build
or run individual parts. The complete run looks like this: 

1. `pdk validate 'metadata,puppet'`
2. Install modules listed in the `metadata.json` file using R10K against a 
   temporary `Puppetfile` at `Puppetfile.pdqtest`
3. Generate a `.fixtures.yml` file based on `metadata.json` 
   Currently impacted by 
   [#47](https://github.com/declarativesystems/pdqtest/issues/47)
4. `pdk test unit`
5. Run all acceptance tests
6. `puppet strings generate --format=markdown` to generate `REFERENCE.md`
7. `pdk build --force` to generate your forge package

At each stage of the process, we output emoji's to keep you informed of
progress. Any failure prevents running the next phase of testing and lint errors
are considered failures.
 
### Technical details (code)
If anyone knows a better way to do this, I'd love to hear about it:
[PDQTest lifecycle](https://github.com/declarativesystems/pdqtest/blob/master/exe/pdqtest)
[PDK Wrapper](https://github.com/declarativesystems/pdqtest/blob/master/lib/pdqtest/pdk.rb)

## PDQTest is pretty slow!
This is a side effect of having to shell out to run PDK via system calls. 
There's really no other way to do this while maintaining full PDK compatiblity 
(if you know different, please enlighten me).

That said you might just want to run syntax and lint tests and acceptance tests
as quick as possible, in which case run:

**Linux**
```
make fast
```

**Windows**
```json
.\make.ps1 fast
```

This runs the syntax and lint tests using the original `puppet-syntax` and
`puppet-lint` libraries. We can't guarantee PDK identical behaviour or 
compatibility when used this way but hey... its faster.

## How do I automatically fix up my lint errors?

With PDK!:

```shell
pdk validate -a
```
